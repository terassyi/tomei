# chezmoi Integration

Use [chezmoi](https://www.chezmoi.io/) for dotfiles, tomei for dev tools and runtimes.

## Directory Layout

```
~/.local/share/chezmoi/                         # chezmoi source (Git repo)
├── .chezmoiscripts/
│   ├── run_once_before_00-install-tomei.sh.tmpl # Install tomei binary
│   └── run_onchange_after_10-tomei-apply.sh.tmpl # Auto-apply on manifest change
├── dot_config/tomei/
│   ├── tools.cue.tmpl                           # Tool manifest (chezmoi template)
│   └── runtimes.cue                             # Runtime manifest (plain CUE)
└── ...
```

chezmoi deploys manifests to `~/.config/tomei/`. CUE infrastructure (`cue.mod/`, `tomei_platform.cue`) is generated by `tomei cue init` and **not** tracked by chezmoi.

## Bootstrap

```bash
sh -c "$(curl -fsLS get.chezmoi.io)" -- init --apply YOUR_GITHUB_USERNAME
```

This triggers:

1. Clone dotfiles repo
2. `run_once_before_00-install-tomei.sh` — install tomei binary
3. Deploy manifests to `~/.config/tomei/`
4. `run_onchange_after_10-tomei-apply.sh` — `tomei init` + `tomei apply`
5. Restart shell (or `eval "$(tomei env)"`) to activate runtime PATHs

## Scripts

### Install tomei (`run_once_before_`)

```bash
{{ if not (lookPath "tomei") -}}
#!/bin/bash
set -euo pipefail
curl -fsSL https://raw.githubusercontent.com/terassyi/tomei/main/install.sh | sh
{{ end -}}
```

### Auto-apply (`run_onchange_after_`)

```bash
#!/bin/bash
set -euo pipefail

# chezmoi re-runs this script when any manifest hash changes.
# tools.cue hash: {{ include "dot_config/tomei/tools.cue.tmpl" | sha256sum }}
# runtimes.cue hash: {{ include "dot_config/tomei/runtimes.cue" | sha256sum }}

export PATH="${HOME}/.local/bin:${PATH}"
TOMEI_DIR="${HOME}/.config/tomei"

[ -f "${HOME}/.local/share/tomei/state.json" ] || tomei init --yes
[ -d "${TOMEI_DIR}/cue.mod" ] || tomei cue init "${TOMEI_DIR}"

tomei apply --yes "${TOMEI_DIR}"
```

## CUE `@tag()` vs chezmoi Templates

| Condition | Use |
|-----------|-----|
| OS/arch/headless differences | CUE `@tag(os)`, `@tag(arch)`, `@tag(headless)` — automatic |
| Work vs personal machine | chezmoi template (`{{ if .work }}`) |
| Team-specific tool sets | chezmoi template |

CUE tags handle platform branching natively. Use chezmoi templates only for user/role-specific branching that CUE tags cannot express.

```cue
// tools.cue.tmpl — chezmoi template for role-based tools
package tomei

import "tomei.terassyi.net/presets/aqua"

commonTools: aqua.#AquaToolSet & {
    metadata: name: "common"
    spec: tools: {
        rg: {package: "BurntSushi/ripgrep", version: "15.1.0"}
        fd: {package: "sharkdp/fd", version: "v10.3.0"}
    }
}

{{ if .work -}}
k8sTools: aqua.#AquaToolSet & {
    metadata: name: "k8s"
    spec: tools: {
        kubectl: {package: "kubernetes/kubectl", version: "v1.32.0"}
        helm:    {package: "helm/helm", version: "v3.17.0"}
    }
}
{{ end -}}
```

## Shell Integration

Add to your shell RC (managed by chezmoi):

```bash
# bash/zsh
command -v tomei > /dev/null 2>&1 && eval "$(tomei env)"
```

```fish
# fish
type -q tomei && tomei env --shell fish | source
```

## See Also

- [Usage](usage.md) — `tomei init`, `tomei apply`, `tomei env` reference
- [CUE Schema](cue-schema.md) — manifest format and `@tag()` usage
- [examples/chezmoi/](../examples/chezmoi/) — ready-to-use templates

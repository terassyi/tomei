name: Weekly Scenario Test

on:
  schedule:
    - cron: '0 9 * * 1' # Monday 9:00 UTC
  workflow_dispatch:

jobs:
  scenario:
    name: Scenario (${{ matrix.os }}/${{ matrix.arch }})
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: linux
            arch: amd64
            runner: ubuntu-latest
          - os: linux
            arch: arm64
            runner: ubuntu-24.04-arm
          - os: darwin
            arch: arm64
            runner: macos-latest
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install tomei
        run: |
          gh release download --repo terassyi/tomei --pattern "tomei_*_${{ matrix.os }}_${{ matrix.arch }}.tar.gz" --output tomei.tar.gz
          sudo tar xzf tomei.tar.gz -C /usr/local/bin tomei
          tomei version
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Initialize tomei
        run: tomei init --yes

      - name: Resolve CUE module dependencies
        run: tomei cue init --force examples/real-world/

      - name: Plan
        run: tomei plan examples/real-world/

      - name: Apply
        run: tomei apply --yes examples/real-world/
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Env
        run: tomei env

      - name: Verify installed tools
        run: |
          eval "$(tomei env)"
          # Runtimes
          go version
          rustc --version
          cargo --version
          uv --version
          pnpm --version
          deno --version
          bun --version
          # Go tools
          gopls version
          staticcheck --version
          goimports -h 2>&1 | head -1
          cue version
          # Aqua tools (utility + k8s)
          bat --version
          rg --version
          fd --version
          jq --version
          yq --version
          fzf --version
          kubectl version --client
          kustomize version
          helm version
          kind version
          # Rust tools
          cargo-binstall -V
          # pnpm tools
          prettier --version
          ts-node --version
          tsc --version
          ncu --version
          # uv tools
          ruff version
          mypy --version
          http --version
          ansible --version
          # bun tools
          biome --version

      - name: Upgrade runtimes to latest
        run: |
          cat > examples/real-world/runtimes.cue << 'CUEEOF'
          package tomei

          import (
          	gopreset "tomei.terassyi.net/presets/go"
          	"tomei.terassyi.net/presets/rust"
          	"tomei.terassyi.net/presets/python"
          	"tomei.terassyi.net/presets/node"
          	"tomei.terassyi.net/presets/deno"
          	"tomei.terassyi.net/presets/bun"
          )

          // Go runtime — resolve latest from go.dev (version omitted → "latest")
          goRuntime: gopreset.#GoRuntime & {
          	platform: {os: _os, arch: _arch}
          }

          // Rust runtime (delegation via rustup)
          rustRuntime: rust.#RustRuntime & {
          	spec: version: "stable"
          }

          // uv runtime (delegation — standalone installer)
          uvRuntime: python.#UvRuntime & {
          	spec: version: "0.10.2"
          }

          // Node.js runtime (delegation via pnpm standalone installer)
          pnpmRuntime: node.#PnpmRuntime & {
          	spec: version: "10.29.3"
          }

          // Deno runtime — resolve latest from dl.deno.land (version omitted → "latest")
          denoRuntime: deno.#DenoRuntime & {
          	platform: {os: _os, arch: _arch}
          }

          // Bun runtime — resolve latest from GitHub releases (version omitted → "latest")
          bunRuntime: bun.#BunRuntime & {
          	platform: {os: _os, arch: _arch}
          }
          CUEEOF
          tomei apply --yes --update-runtimes examples/real-world/
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify tools after runtime upgrade
        run: |
          eval "$(tomei env)"
          # Download-type runtimes (resolved to latest)
          go version
          deno --version
          bun --version
          # Dependent tools
          gopls version
          biome --version

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: scenario-logs-${{ matrix.os }}-${{ matrix.arch }}
          path: ~/.local/share/tomei/
          retention-days: 7
